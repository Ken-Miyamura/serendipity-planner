# Serendipity Planner - 機能仕様

## 1. 隙間時間検出

### 概要

EventKit を使用してユーザーのカレンダーからイベントを取得し、スケジュールの合間にある空き時間（隙間時間）を自動的に検出します。

### 仕組み

1. 当日の開始時刻〜終了時刻の範囲でカレンダーイベントを取得
2. イベント間のギャップを計算
3. 最小時間（デフォルト 60 分）以上のギャップを `FreeTimeSlot` として返却
4. アクティブ時間帯の外にある時間は除外

### アクティブ時間帯

ユーザーが活動する時間帯を平日・休日で個別に設定できます。

| 区分 | デフォルト開始 | デフォルト終了 |
|------|-------------|-------------|
| 平日 | 8:00 | 20:00 |
| 休日 | 10:00 | 22:00 |

### 祝日判定

- カレンダーの購読（subscription）カレンダーから祝日を取得
- 祝日の場合は休日のアクティブ時間帯設定を適用

### iOS 17 対応

- iOS 17+ では `requestFullAccessToEvents()` を使用
- iOS 17 未満では `requestAccess(to: .event)` にフォールバック

---

## 2. 提案カテゴリ

10 種類のカテゴリから、コンテキストに応じた体験を提案します。

| カテゴリ | 表示名 | アイコン | 屋内/屋外 |
|---------|-------|---------|----------|
| cafe | カフェ | cup.and.saucer.fill | 屋内 |
| walk | 散歩 | figure.walk | 屋外 |
| reading | 読書 | book.fill | 屋内 |
| music | 音楽 | music.note | 屋内 |
| art | アート | paintpalette.fill | 屋内 |
| fitness | フィットネス | figure.run | 屋内/屋外 |
| shopping | ショッピング | bag.fill | 屋内 |
| gourmet | グルメ | fork.knife | 屋内 |
| movie | 映画 | film.fill | 屋内 |
| meditation | リラックス | leaf.fill | 屋内/屋外 |

各カテゴリには `WeightProfile` が定義されており、天気・時間帯・空き時間長に基づく重み補正パラメータを保持します。詳細は [suggestion-algorithm.md](../architecture/suggestion-algorithm.md) を参照してください。

---

## 3. 天気連動

### OpenWeatherMap API

- エンドポイント: `https://api.openweathermap.org/data/2.5/weather`
- パラメータ: 座標（lat/lon）、単位（metric）、言語（ja）
- API キーは `Info.plist` の `OpenWeatherMapAPIKey` から取得

### 天気条件

| 条件 | 表示名 | アウトドア適性 |
|------|-------|-------------|
| clear | 晴れ | 適 |
| clouds | 曇り | 適 |
| rain | 雨 | 不適 |
| drizzle | 小雨 | 不適 |
| thunderstorm | 雷雨 | 不適 |
| snow | 雪 | 不適 |
| mist | 霧 | 不適 |
| unknown | 不明 | 適 |

### キャッシュ

- UserDefaults にキャッシュ（キー: `weather_cache_coord_XX.XX_YY.YY`）
- 有効期限: 1 時間（`Constants.Weather.cacheExpirationSeconds = 3600`）
- 期限切れの場合は API を再呼び出し

### フォールバック

- 位置情報が取得できない場合: モック天気データを使用（晴れ・22°C）
- API エラーの場合: 同じくモック天気データにフォールバック

---

## 4. 近隣スポット検索

### MapKit MKLocalSearch

- カテゴリごとに定義された検索クエリでスポットを検索
- 検索半径: 1,500m（1.5km）
- 結果を距離順にソートし、上位 5 件からランダムに 1 件を選択
- 名前による重複排除

### カテゴリ別検索クエリ

| カテゴリ | 検索クエリ |
|---------|-----------|
| cafe | カフェ, コーヒー |
| walk | 公園, 散歩 |
| reading | 図書館, 書店, ブックカフェ |
| music | 音楽カフェ, レコードショップ, ライブハウス |
| art | ギャラリー, 美術館 |
| fitness | ジム, フィットネス, ヨガ |
| shopping | 雑貨, ブティック, ショッピング |
| gourmet | レストラン, グルメ |
| movie | 映画館, シネマ |
| meditation | お寺, スパ, 瞑想 |

### スポット情報の表示

- スポット名
- 距離（m / km）
- 徒歩時間（80m/分で計算）
- MapKit 地図上のカスタムピン

---

## 5. 学習システム

### 選択履歴ベースの重み付け

ユーザーが提案を受け入れるたびに、そのカテゴリの選択回数をインクリメントし、将来の提案確率に反映します。

### 重み計算ロジック

1. 選択履歴なし: 全カテゴリ均等（`1.0 / カテゴリ数`）
2. 選択履歴あり:
   - 最小保証重み: `max(0.05, 1.0 / (カテゴリ数 × 3.0))`
   - 各カテゴリに最小保証を確保
   - 残りの重みを選択比率に応じて分配

### 最小保証

全カテゴリに最低 5%（または `1/(3N)`）の選択確率を保証することで、特定カテゴリに偏りすぎることを防ぎます。

### データ管理

- 選択回数は `UserPreference.selectionCounts` に `[String: Int]` 形式で保存
- 設定画面からリセット可能

---

## 6. 通知システム

### 朝の概要通知

- 毎朝指定時刻（デフォルト 7:00）にリピート通知
- 本日の空き時間スロット数を表示
- 例: 「今日は 3 つの空き時間があります。素敵な体験を見つけましょう！」

### 隙間時間前通知

- 各隙間時間の開始前にワンタイム通知
- リードタイム: 5 / 10 / 15 / 30 / 60 分前（デフォルト 15 分）
- 提案内容のプレビューを表示

### 設定項目

| 設定 | デフォルト | 範囲 |
|------|---------|------|
| 通知の有効/無効 | 無効 | - |
| 朝の通知の有効/無効 | 有効 | - |
| 朝の通知時刻 | 7:00 | 6:00〜10:00 |
| 隙間時間前通知の有効/無効 | 有効 | - |
| 通知リードタイム | 15 分 | 5 / 10 / 15 / 30 / 60 分 |

---

## 7. カレンダー登録

提案を「受け入れ」ると、EventKit を通じてユーザーのデフォルトカレンダーにイベントを追加します。

### 登録内容

- タイトル: 提案のタイトル
- 開始/終了: 隙間時間スロットの時間範囲
- メモ: 提案の説明文
- カレンダー: デフォルトカレンダー

### 受け入れフロー

1. ユーザーが「受け入れ」ボタンをタップ
2. `PreferenceService` に選択を記録（学習システム）
3. `CalendarService.addEvent()` でイベント追加
4. 受け入れ済みリストに移動
5. UserDefaults に永続化

---

## 8. オンボーディング

初回起動時に 5 画面構成のオンボーディングフローを表示します。

### 画面構成

| # | 画面 | 内容 |
|---|------|------|
| 1 | ウェルカム | アプリの紹介、主要機能の説明 |
| 2 | 興味選択 | 10 カテゴリから 3 つ以上を選択（デフォルト: カフェ、散歩、読書） |
| 3 | カレンダー権限 | EventKit のアクセス許可リクエスト |
| 4 | 通知権限 | 通知の許可リクエスト |
| 5 | 位置情報 | 位置情報のアクセス許可リクエスト |

### 動作

- ページインジケーター（ドット）で現在位置を表示
- 興味選択画面は 3 つ以上選択するまで「次へ」ボタンが無効
- 各権限画面では許可済みの場合「許可済み」と表示
- 最終画面で「はじめる」をタップするとメイン画面に遷移
- 権限は後から設定アプリで変更可能

---

## 9. 提案テンプレート

各カテゴリに 2〜3 個のテンプレートが定義されており、空き時間の長さに応じて適切なものが選択されます。

### テンプレート例

| カテゴリ | テンプレート | 最小時間 |
|---------|-----------|---------|
| カフェ | 近くのカフェでひと息 | 30 分 |
| カフェ | カフェで作業タイム | 60 分 |
| 散歩 | 近所をお散歩 | 20 分 |
| 散歩 | フォトウォーク | 45 分 |
| 読書 | 読書タイム | 30 分 |
| 読書 | 雑誌・記事を読む | 20 分 |
| 映画 | 映画館で最新作を | 90 分 |
| リラックス | 瞑想タイム | 20 分 |

### テンプレート選択ロジック

1. カテゴリに紐づくテンプレート一覧を取得
2. `minDuration <= 空き時間` のテンプレートをフィルタ
3. フィルタ結果からランダムに 1 件選択
4. 該当なしの場合は先頭のテンプレートを使用

---

## 10. 履歴機能

### 概要

ユーザーが受け入れた提案の履歴を自動的に保存し、月単位で振り返ることができる機能です。

### 履歴の保存

- 提案を「受け入れる」と、`HomeViewModel.acceptSuggestion()` 内で `HistoryService.saveHistory()` が呼ばれ自動保存
- 保存される情報：提案データ（Suggestion）、受け入れ日時、場所名、住所

### 履歴一覧画面（HistoryView）

- タブバーの「履歴」タブからアクセス
- 月単位のナビゲーション（＜ ＞ ボタンで前月/次月に切り替え）
- 当月のカテゴリ別サマリー表示（HistorySummaryView）
- 日付ごとにグループ化した履歴リスト

### 月のサマリー（HistorySummaryView）

- カテゴリアイコン + カテゴリ名 + 回数を 3 列グリッドで表示
- 合計回数を右上に表示
- カード背景でグラデーション上でも見やすく

### 履歴行（HistoryRowView）

- カテゴリアイコン（円形カラー背景）
- 提案タイトル、時刻、場所名
- カテゴリバッジ
- カード背景 + シャドウ

### データ管理

- `HistoryService`（HistoryServiceProtocol 準拠）で永続化
- UserDefaults に `[SuggestionHistory]` を JSON で保存
- キー: `Constants.Storage.suggestionHistoryKey`
- 月別フィルタ・カテゴリ別集計メソッドを提供
- 個別削除・全件削除に対応

---

## 11. 天気コンテキスト文

各カテゴリには天気条件（アウトドア向き / インドア向き / 中立）に応じた 3 パターンのコンテキスト文が定義されています。

### 例（カフェ）

- アウトドア向き天気: 「晴れで22°C。テラス席も気持ちよさそうです。」
- インドア向き天気: 「雨の日は、温かいカフェでゆっくりしましょう。」
- 中立: 「曇りで18°C。カフェでほっとひと息つきましょう。」
