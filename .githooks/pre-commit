#!/bin/bash
#
# pre-commit hook: SwiftFormat + SwiftLint をステージ済み .swift ファイルに実行
#

set -euo pipefail

# ステージ済みの .swift ファイルを取得（削除されたファイルは除外）
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=d -- '*.swift')

if [ -z "$STAGED_SWIFT_FILES" ]; then
    exit 0
fi

PASS=true

# --- SwiftFormat ---
if command -v swiftformat &> /dev/null; then
    echo "Running SwiftFormat..."
    if ! echo "$STAGED_SWIFT_FILES" | xargs swiftformat --lint --quiet 2>&1; then
        echo ""
        echo "SwiftFormat: フォーマット違反があります。'swiftformat .' で自動修正してください。"
        PASS=false
    fi
else
    echo "warning: swiftformat がインストールされていません (brew install swiftformat)"
fi

# --- SwiftLint ---
if command -v swiftlint &> /dev/null; then
    echo "Running SwiftLint..."
    if ! echo "$STAGED_SWIFT_FILES" | xargs swiftlint lint --strict --quiet 2>&1; then
        echo ""
        echo "SwiftLint: lint違反があります。修正してからコミットしてください。"
        PASS=false
    fi
else
    echo "warning: swiftlint がインストールされていません (brew install swiftlint)"
fi

if ! $PASS; then
    echo ""
    echo "コミットを中止しました。上記の問題を修正してください。"
    exit 1
fi
